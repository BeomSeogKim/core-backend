# 트랜잭션 (Transaction)
데이터베이스에서 데이터를 처리하는 **하나의 논리적인 작업 단위**를 의미한다.

## 트랜잭션은 왜 필요한가?
고객 A가 B에게 10,000원을 이체를 하는 상황을 가정 해 보면 다음의 두 단계로 나뉜다.
1. 출금 : A의 잔액에서 10,000원을 뺀다.
2. 입금 : B의 잔액에 10,000원을 더한다.

여기서 둘 중 하나만 성공적으로 실행된다면 돈이 증발하거나, 없는 돈이 생기는 심각한 문제가 발생한다.

이 때 트랜잭션이 두 과정을 하나로 묶어 중간에 하나라도 실패하면 모든 작업을 취소시켜 데이터의 안전을 보장한다.

## Commit 그리고 Rollback
**Commit**
- 트랜잭션 내 모든 작업을 정상적으로 처리하겠다고 확정하는 명령어
- 트랜잭션 내 작업 내용이 실제 DB에 저장됨

**Rollback**
- 트랜잭션 내 문제가 발생했으니 되돌리겠다고 하는 명령어
- 트랜잭션 내 모든 작업 내용을 취소한다. (이전 Commit한 곳 까지만 복)

## ACID
트랜잭션이 안전하게 수행된다는 것을 보장하기 위해 필요한 4가지 성질

**Atomicity**
- 트랜잭션 내의 작업들은 분리 될 수 없다
- 전체가 다 성공하거나, 하나라도 실패하면 전체가 취소되어야 한다

**Consistency**
- 트랜잭션이 성공적으로 완료되면 데이터베이스는 언제나 일관된 상태를 유지해야 한다
- e.g. 송금 전 후 총 잔액의 합계는 같아야 한다, 데이터 타입 제약 조건 준수 등

**Isolation**
- 여러 트랜잭션이 동시에 실행될 때, 서로의 작업에 끼어들거나 영향을 줄 수 없다
- 마치 혼자 실행되는 것 처럼 독립적이어야 한다 (`격리 수준`을 통해 조절 가능)

**Durability**
- 트랜잭션이 성공적으로 완료되었다면 (Commit) 그 결과는 영구적으로 반영되어야 한다
- 시스템이 셧다운 되어도 데이터는 날아가면 안된다

## 이상 현상 (Anomaly)
격리 수준에 따라서 DB에서 발생할 수 있는 3가지 대표적인 이상현상은 다음과 같다.

**Dirty Read**

다른 트랜잭션이 아직 커밋하지 않은 데이터를 읽어버리는 현상 (작업 중 롤백되면 엉뚱한 데이터를 읽은 셈)

**Non-Repeatable Read**

한 트랜잭션 내에서 같은 데이터를 두 번 조회했는데, 그 사이에 다른 트랜잭션이 값을 수정하고 커밋해버려 값이 달라지는 현상

**Phantom Read**

한 트랜잭션 내에서 일정 범위의 데이터를 조회했는데, 다른 트랜잭션이 데이터를 추가 혹은 삭제하여 없던 데이터가 갑자기 튀어나오거나 사라지는 현상

## 격리성 레벨
동시에 실행되는 트랜잭션 간의 간섭을 얼마나 허용할 것인지 결정하는 설정

격리성이 높을수록 데이터 정합성은 보장되나 동시성이 낮아지며 격리성이 낮을수록 동시성이 높아지나 정합성은 떨어진다.

| Isolation Level           | Dirty Read | Non-Repeatable Read | Phantom Read |
|---------------------------|------------|---------------------|--------------|
| READ Uncommitted <br> Lv0 | O          | O                   | O            |
| READ Comitted <br> Lv1    | X          | O                   | O            |
| Repeatable Read <br> Lv2  | X          | X                   | O            |
| Serializable <br> Lv3     | X          | X                   | X            |

**Read Uncommitted**
- 가장 낮은 격리수준으로, 다른 트랜잭션이 커밋하지 않은 데이터를 읽어온다.
- Dirty Read 문제가 발생할 수 있다.

**Read Committed**
- 트랜잭션이 **커밋을 완료한** 데이터만 읽을 수 있다.
- Oracle, PostgreSQL 등의 기본값
- Dirty Read는 발생하지 않지만, Non-Repeatable Read 문제는 발생할 수 있다.

**Repeatable Read**
- MySQ(InnoDB)L의 기본설정으로 트랜잭션이 시작될 때의 시점을 기준으로 스냅샷을 찍어두고, 트랜잭션 내내 그 스냅샷만 본다.
- 트랜잭션 도중 다른 누가 데이터를 수정하고 커밋해도, 나는 내가 처음에 봤던 데이터만 계속 보기에 Non-Repeatable 문제가 발생하지 않음.
- 이론적으로는 Phantom Read가 발생할 수 있으나, MySQL InnoDB는 MVCC와 Next-Key Lock등을 이용해 이 단계에서도 Phantom Read를 어느정도 방지한다.

**Serializable**
- 가장 엄격한 수준으로, 트랜잭션을 아예 순차적으로 실행시키는 것과 같다.
- 읽기 작업에도 Lock을 거는 방식
- 데이터의 이상현상은 발생하지 않으나, 동시 처리 성능이 극도로 떨어진다. 
